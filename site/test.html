<html>
  <head>
    <style>
      * {
        font-family: Verdana;
      }
      .spacer {
        flex: 1;
      }
      .board {
        display: flex;
        flex-direction: column;
        font-family: monospace;
        border: 1px solid #000;
      }
      .board-row {
        display: flex;
      }
      .square {
        height: 50px;
        width: 50px;
        border: 1px solid #000;
        display: flex;
        flex-direction: column;
      }
      .token-row {
        flex: 1;
        display: flex;
        flex-direction: row;
      }
      .token {
        flex: 1;
        margin: auto;
        text-align: center;
        font-size: 15pt;
      }
      .bot0 {
        color: red;
      }
      .bot1 {
        color: blue;
      }
      .symbol-type {
        padding: 1ex;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="./embindings.js"></script>
    <script type="text/babel">
      var levels = {
        "not": "../examples/not.lvl",
        "xor": "../examples/xor.lvl",
        "rainbow": "../examples/rainbow.lvl",
        "median": "../examples/median.lvl",
        "adder": "../examples/adder.lvl",
      };
      Module.onRuntimeInitialized = _ => {
        console.log("loaded");
      }
      var board;
      var level;
      var submission;
      function compute() {
        // level = document.getElementById("level").value;
        submission = document.getElementById("submission").value;
        board = Module.LoadBoard(level, submission);
        console.log(board.check_status());
        // board.run(100);
        // console.log(board.check_status());
      }
      function getFileFromServer(url, doneCallback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            doneCallback(xhr.status == 200 ? xhr.responseText : null);
          }
        }
        xhr.open("GET", url, true);
        xhr.send();
      }
      function pickLevel() {
        var path = levels[document.getElementById("level_select").value];
        getFileFromServer(path, function(text) {
          if (text !== null) level = text;
        });
      }

      class Square extends React.Component {
        render() {
          return (
            <div className="square">
              <div className="token-row">
                <div className="token unresolved">{this.props.unresolved}</div>
                <div className="token bot0 direction">{this.props.directions[0]}</div>
                <div className="token bot1 direction">{this.props.directions[1]}</div>
              </div>
              <div className="token-row">
                <div className="token resolved">{this.props.resolved}</div>
                <div className="token bot0 operation">{this.props.operations[0]}</div>
                <div className="token bot1 operation">{this.props.operations[1]}</div>
              </div>
            </div>
          );
        }
      }

      class Board extends React.Component {
        renderSquare(props, y, x) {
          return (<Square key={y,x} {...props}/>);
        }

        render() {
          return (
            <div className="board">
              {this.props.squares.slice(0, this.props.m).map((row, y) =>
                <div key={y} className="board-row">
                  {row.slice(0, this.props.n).map((col, x) => this.renderSquare(col, y, x))}
                </div>
              )}
            </div>
          );
        }
      }

      class Game extends React.Component {
        constructor(props) {
          super(props);
          this.colors = ["RED", "BLUE"];
          this.symbolHandler = this.symbolHandler.bind(this);
          this.state = {
            squares: Array(this.props.m).fill(Array(this.props.n).fill({
              unresolved: null,
              resolved: null,
              directions: [null, null],
              operations: [null, null],
            })),
            bot: 0,
            // selection on board
            board_selection_bot: null,
            board_selection_y: null,
            board_selection_x: null,
            board_selection_type: null, // cell, direction, operation
            // selection on creation
            creation_selection_bot: 0,
            symbolGroup: null,
            // creation_selection_type: null, // "x", "GRAB / DROP", etc
            // creation_selection_value: null, // "x", "GRAB", etc
            // creation_selection_options: null, // JSX
          };
        }

        render() {
          return (
            <div style={{display:"flex", flexDirection:"column", width:"min-content"}} className="game">
              <div style={{display:"flex"}} className="game-board">
                <Board m={this.props.m} n={this.props.n} squares={this.state.squares}/>
              </div>
              <div style={{display:"flex", flexDirection:"row"}}>
                <div style={{flex:4, display:"flex", flexDirection:"row", flexWrap: "wrap"}}>
                  <Symbol type="operation" subtype="START" value="S" handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="NEXT" value="n" handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="GRAB/DROP" options={{GRAB: "g", DROP: "d", SWAP: "w"}} handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="LATCH/UNLATCH" options={{LATCH: "l", UNLATCH: "u", "TOGGLE LATCH": "t"}} handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="REFRESH" value="*" handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="SYNC" value="s" handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="ROTATE" value="r" handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="BRANCH(|/)" options={{"<": "<", "v": "v", ">": ">", "^": "^"}} handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="BRANCH(-\)" options={{"<": "[", "v": "W", ">": "]", "^": "M"}} handler={this.symbolHandler}/>
                  <Symbol type="operation" subtype="POWER" options={{"TOGGLE POWER 1": "p", "TOGGLE POWER 2": "P"}} handler={this.symbolHandler}/>
                </div>
                <div style={{flex:1, display:"flex", flexDirection:"column"}}>
                  {[0, 1].map(bot =>
                    <div key={`radio-bot-${bot}`} className={`bot${bot}`}>
                      <input type="radio" id={`radio-bot-${bot}`} value={bot} name="color"
                          checked={this.state.creation_selection_bot === bot}
                          onChange={event => { this.setState({creation_selection_bot: Number(event.target.value)}); }}
                      />
                      <label htmlFor={`radio-bot-${bot}`}>{this.colors[bot]}</label>
                    </div>
                  )}
                </div>
                <div style={{flex:1, display:"flex", flexDirection:"column"}}>
                  {this.state.symbolGroup !== null && this.state.symbolGroup.getOptions !== undefined ? this.state.symbolGroup.getOptions() : null}
                </div>
              </div>
              <div className="game-info">
                <div>{/* status */}</div>
                <ol>{/* TODO */}</ol>
              </div>
            </div>
          );
        }

        symbolHandler(symbolGroup) {
          this.setState({symbolGroup: symbolGroup});
        }
      }

      class Symbol extends React.Component {
        constructor(props) {
          super(props);
          // props: type, subtype, value, options
          this.state = {};
          this.state.value = this.props.value;
          if (this.props.options !== undefined) {
            this.state.selected = Object.keys(this.props.options)[0];
            value: this.props.options[this.state.selected];
          }
        }
        setSelected(option, callback) {
          this.setState({
            selected: option,
            value: this.props.options[option],
          },
          callback);
        }
        render() {
          return (
            <div className="symbol-type" onClick={() => {this.props.handler(this);}}>{this.props.subtype}</div>
          );
        }
        getOptions() {
          return (
            <div className="symbol-options" onChange={this.onChangeValue}>
              {Object.keys(this.props.options || []).map(option =>
                <div style={{display:"flex", alignItems:"center"}} key={`radio-option-${option}`}>
                  <input type="radio" id={`radio-${option}`} value={option} name={`radio-for-${this.subtype}`}
                      checked={this.state.selected === option}
                         onChange={event => { this.setSelected(event.target.value, () => {this.props.handler(this);}); }}
                  />
                  <label htmlFor={`radio-${option}`}>{option}</label>
                </div>
              )}
            </div>
          );
        };
      }

      ReactDOM.render(
        <Game m={10} n={14}/>,
        document.getElementById('game')
      );
    </script>

    <div style="display:flex;">
      <div style="margin:1vw; display:flex; flex-direction:column;">
        <div>
          <label for="level_select">Choose level:</label>
          <select name="level_select" id="level_select" onchange="pickLevel()">
            <option value="not">not</option>
            <option value="xor">xor</option>
            <option value="rainbow">rainbow</option>
            <option value="median">median</option>
            <option value="adder">adder</option>
          </select>
        </div>
        <textarea name="submission" id="submission" rows=20 cols=40></textarea>
        <input type="button" value="Validate" onclick="compute();" />
      </div>
      <div style="margin:1vw;" id="game"></div>
    </div>
  </body>
</html>
